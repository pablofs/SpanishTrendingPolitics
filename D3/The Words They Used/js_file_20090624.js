var data = {};

(function() {

data.parties = [{name: "democrat", speeches: ["\nJOAN RIDAO I MARTÍN: PIENSA EL PRESIDENTE DEL GOBIERNO, DESPUÉS DE LA INAUGURACIÓN DE LA NUEVA TERMINAL DEL AEROPUERTO DE BARCELONA-EL PRAT, IMPULSAR LA REVISIÓN DE TODOS LOS CONVENIOS DE CARÁCTER BILATERAL FIRMADOS POR ESPAÑA Y PAÍSES AJENOS A LA UNIÓN EUROPEA, QUE ESTABLECEN COMO ÚNICO DESTINO PARA LOS VUELOS INTERNACIONALES EL AEROPUERTO MADRID-BARAJAS Y COMO ÚNICO OPERADOR LA COMPAÑÍA IBERIA\nJOAN RIDAO I MARTÍN:  Gracias, señor presidente.\nJOAN RIDAO I MARTÍN:  Gracias, señor presidente. Perdone, señor presidente del Gobierno, pero hoy la pregunta va de aviones y de aeropuertos. Concretamente, ¿por qué su Gobierno mantiene suscritos con veintitrés países convenios bilaterales que hacen que el aeropuerto de Madrid-Barajas sea el único destino de vuelos internacionales en el Estado español?\nJOAN RIDAO I MARTÍN:  Gracias, señor presidente.\nJOAN RIDAO I MARTÍN:  Gracias, señor presidente. Efectivamente, la inauguración de la nueva terminal de El Prat ha sido una buena noticia que no solo aumentará su capacidad, sino que también va a permitir más y mejores conexiones de vuelos, pero usted sabe que el aeropuerto de El Prat no tiene solo un problema de espacio, de capacidad, aunque esté bien prever futuros colapsos, porque de hecho la vieja terminal, con cinco veces menos espacio, hoy ya puede gestionar un tránsito de hasta 30 millones de pasajeros y, por tanto, está perfectamente capacitada para todo tipo de operaciones con Europa y a nivel internacional. De hecho, una buena instalación es una condición necesaria pero no suficiente. Hay aeropuertos más pequeños que el de Barcelona, como Manchester, Milán o Viena, que tienen más vuelos intercontinentales; Barcelona solo tiene el 5,4 por ciento de todo el Estado. ¿Qué diferencia hay entre estos aeropuertos y el de Barcelona? En primer lugar, que hay un gran potencial y eso lo tiene Barcelona y, en segundo lugar, que tienen una gestión descentralizada y mucho más competitiva porque no hay interferencias políticas de ningún tipo y los gestores dependen, evidentemente, de su acierto. A finales de este año habrá ese nuevo modelo de gestión y ya lo veremos, aunque sea con retraso, porque usted lo comprometió hace un año. Se trata de acabar, en definitiva, con ese modelo radial centralista de kilómetro cero, con ese modelo incluso ideológico de grandes infraestructuras, que son para ustedes una herramienta de ordenación del poder territorial para articular España y para que su capital esté bien conectada con el mundo. Por eso nació precisamente AENA. Ese es el modelo de la antigua Unión Soviética, señor presidente. (Varios señores diputados: ¡Hala!) Por eso El Prat, hoy por hoy, todavía es un aeropuerto subsidiario, un aeropuerto de segunda y un aeropuerto que funciona como gran alimentador del aeropuerto Madrid-Barajas. El ejemplo precisamente de eso es el centralismo y el intervencionismo de ustedes cuando mantienen todavía hoy -celebro que deseen cambiarlo- esos veintitrés convenios internacionales que dicen que el aeropuerto de El Prat es el único destino internacional y que la única compañía operadora es Iberia. Muchas gracias.",
"\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Muchas gracias, señor presidente. Señor Ridao, le agradezco su comentario, pero sin duda no va a afectar al contenido de mi respuesta. Le diré que, en primer lugar, expreso mi satisfacción por lo que representa la nueva terminal de El Prat, que ha tenido desde su entrada en funcionamiento una valoración muy positiva por la opinión pública y espero que represente un impulso muy importante para Cataluña y Barcelona. Por lo que afecta al contenido concreto de su pregunta, quiero decirle que, fuera del ámbito de la Unión Europea, el establecimiento de vuelos regulares internacionales requiere, en efecto, acuerdos bilaterales entre los países afectados, aunque la creación de un cielo único europeo trae consigo que muchos de los nuevos acuerdos se establezcan ya entre la Unión Europea y terceros países. Al margen de estos acuerdos de la Unión Europea, España mantiene 80 acuerdos bilaterales y en 57 de estos 80 acuerdos las compañías de los vuelos con los que firma el convenio pueden elegir libremente el aeropuerto español de destino. Solo en veintitrés casos, que se refieren a países en vías de desarrollo, que no cuentan con compañías aéreas propias o que presentan alguna otra especificidad, no se da esta libertad de elección. Nuestro objetivo cuando actualizamos esos acuerdos es también la liberalización total de los aeropuertos y de las compañías que en ellos operan y con este fin hemos actualizado en los últimos dos años acuerdos con Estados Unidos, Argelia, Australia, Brasil, Costa de Marfil, Gambia, Mauricio, México y Omán y estamos negociando con tres países más, Costa Rica, Uruguay y Mauritania. Además, como afirma el estudio de la Cámara de Comercio de Barcelona, las exclusiones existentes en los acuerdos antiguos no son impedimento para la creación de nuevas rutas. En definitiva, el Gobierno, por supuesto, no impulsa ninguna política que discrimine a un aeropuerto en beneficio de otro y en la renovación de los convenios a los que he hecho referencia impulsaremos más bien lo contrario, facilitar el tránsito a aeropuertos, entre ellos, lógicamente, al de El Prat. Muchas gracias. (Aplausos.)\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Muchas gracias, señor Ridao. En efecto, tiene razón cuando afirma que la nueva terminal es la garantía para que las condiciones de El Prat mejoren y su capacidad de interrelación. Estamos de acuerdo en que hay que modificar el modelo de gestión, vamos a trabajar en ello -es un compromiso que el Gobierno tiene- y, por supuesto, estamos plenamente comprometidos a que en la modificación de los convenios se abran nuevas oportunidades para El Prat. Muchísimas gracias. (Aplausos.)\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Muchas gracias, señor presidente. Ya puede suponer el señor Erkoreka que, evidentemente, el Gobierno ha hecho gestiones continuas en torno a la fuente de espalación de neutrones en Bilbao, esa gran instalación tecnológica. Sabe que hemos dotado con una financiación de 10 millones de euros para incrementar incrementar la capacidad científica y tecnológica en Euskadi o un centro mixto del consejo superior en la Universidad del País Vasco. En efecto, el desenlace -usted lo ha explicado de manera parcial- básicamente supone que Suecia albergará la sede principal del proyecto y Bilbao una sede complementaria. Creo que el matiz tiene su importancia. Bilbao contará con tres instalaciones: un centro tecnológico de aceleradores, un laboratorio de pruebas y un centro de desarrollo informático. A España corresponderá un 10 por ciento de la propiedad del conjunto del proyecto y ostentará una vicepresidencia. El desarrollo de estas infraestructuras en Vizcaya supondrá una inversión de 180 millones de euros en cinco años. Ya en 2009 los gobiernos vasco y estatal, fruto del acuerdo que teníamos, hemos comprometido 30 millones para que las obras comiencen de manera inmediata y estén finalizadas en 2011. Esa es la situación. En ningún momento -creo que me ha escuchado más bien afirmar lo contrario- he negado el esfuerzo, la iniciativa y la colaboración que el anterior Gobierno del País Vasco y el Gobierno de España han tenido en el objetivo de la fuente de espalación de neutrones. No hemos conseguido, como es evidente, el objetivo que nos proponíamos, pero el acuerdo final da unas posibilidades al País Vasco en su capacidad tecnológica considerables y que, desde nuestro punto de vista, son muy positivas para el futuro de la investigación en esa comunidad autónoma y en España. Gracias. (Aplausos.)\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Gracias, señor presidente. Señor Erkoreka, yo no dudo de que la candidatura era buena, también la sueca, y creo que usted conoce el método comunitario y que, como es normal, candidaturas a distintas opciones de centros tecnológicos o de otro tipo de sedes de instituciones tienen un proceso natural en el que se intenta hacer un equilibrio razonable y, obviamente, España unas veces obtiene sus objetivos y otras no, como todos los países, pero le puedo asegurar que trabajé con todos los... (Aplausos.)\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Gracias, señor presidente. Señor Rajoy, vamos a las cosas que son claras. Es claro que el Gobierno que presido tuvo superávit en los cuatro años de la legislatura anterior; es claro que el objetivo del Gobierno es recuperar el Pacto de Estabilidad en el año 2012, como ha pedido la Comisión Europea, después del esfuerzo fiscal que estamos haciendo para combatir la crisis económica; es claro que el Gobierno que presido ha disminuido la presión fiscal en España como consecuencia de la reducción del impuesto sobre sociedades, del impuesto sobre la renta de las personas físicas y de la supresión del impuesto del patrimonio. Cuando llegamos al Gobierno teníamos una presión fiscal del 34 por ciento en relación con el PIB y ahora estamos en el 32,8 por ciento del PIB. Es claro que el objetivo del Gobierno es seguir manteniendo un equilibrio fiscal razonable para cumplir los objetivos que queremos, que son: mantener la inversión productiva para que el país recupere su capacidad económica, mantener la protección social y llegar a esa meta del 3 por ciento conforme al Pacto de Estabilidad en 2012. Esos son los objetivos del Gobierno y esas son las cosas claras que han pasado. Lógicamente, hay que esperar al momento de los próximos presupuestos para saber lo que vamos a debatir en ellos y conocer las distintas posiciones de la Cámara, pero lo que ha hecho el Gobierno en estos años es superávit y bajar impuestos. Ahora tenemos una situación nueva que afrontaremos de aquí al año 2012 para lograr ese Pacto de Estabilidad en el que hemos estado, que defendemos y con el que tenemos un firme compromiso. Muchas gracias. (Aplausos.)\nJOSÉ LUIS RODRÍGUEZ ZAPATERO:  Muchas gracias, señor presidente. Señor Rajoy, es verdad que usted es solo especialista en glosar las alternativas posibles de las políticas de los demás, porque en sus alternativas sigue inédito día tras día, sesión tras sesión, debate tras debate; no tiene absolutamente ninguna alternativa. (Aplausos.) Lo que es efectivamente previsible es que usted no escucha, porque acabo de decirle en la primera parte de mi respuesta cuáles son los objetivos en relación con el Pacto de Estabilidad, con la política fiscal, lo que hemos hecho y adónde queremos llegar. Eso es previsibilidad, y le debo recordar que nuestro país tiene veinte puntos por debajo de la media de deuda pública en relación con el PIB y que nuestro país, como la gran mayoría, incurre en déficit este año y el siguiente, y en 2012 volveremos a la estabilidad y posteriormente... (Aplausos.)"]}, {name: "republican", speeches: ["\nJOSU IÑAKI ERKOREKA GERVASIO: QUÉ LUGAR HA OCUPADO EN SU AGENDA INTERNACIONAL, EN LOS ÚLTIMOS TRES AÑOS, EL PROYECTO DE UBICACIÓN EN BILBAO DE LA FUENTE EUROPEA DE ESPALACIÓN DE NEUTRONES, ESS",
"\nMARIANO RAJOY BREY: CÓMO VALORA EL PRESIDENTE DEL GOBIERNO LAS CRÍTICAS DEL BANCO DE ESPAÑA AL INCREMENTO DEL DÉFICIT PÚBLICO, QUE LLEVA A SUBIDAS DE IMPUESTOS Y AL EMPOBRECIMIENTO DE LAS CLASES MEDIAS\nMARIANO RAJOY BREY:  Muchas gracias.\nMARIANO RAJOY BREY:  Muchas gracias. Hace escasas fechas el gobernador del Banco de España compareció aquí y dijo algunas cosas que en mi opinión son muy razonables. Lo más importante fue su afirmación de que hay que cambiar la política económica, que consiste en aumentar el gasto y la deuda hasta el infinito y no hacer reformas. Dijo el gobernador que había que volver a la estabilidad presupuestaria. Yo estoy de acuerdo, y llevo diciéndolo desde hace mucho tiempo. Si no es así, la confianza se deteriorará más, se encarecerá el crédito a las empresas y a las familias, se forzarán nuevas subidas de impuestos y habrá más recesión y más paro. A mí me gustaría conocer su criterio sobre las afirmaciones del gobernador, si va usted a rectificar su política económica y si va o no a subir los impuestos, porque no hay quien se aclare, señor presidente. (Aplausos.)\nMARIANO RAJOY BREY:  Muchas gracias.\nMARIANO RAJOY BREY:  Muchas gracias. Señor presidente, lo único que veo claro es que no hay un criterio claro en la política económica del Gobierno. España es el segundo país de Veintisiete donde más ha aumentado la deuda pública. España es el segundo país de Veintisiete con más déficit público, solamente superado por Irlanda. Las cuentas públicas están descontroladas, tanto en su capítulo de gastos como en el de ingresos. Y lo peor es que no sabemos qué va a hacer usted en los temas esenciales, qué política económica va a hacer usted. ¿Usted va a subir impuestos, como acordó a las catorce horas del día de ayer, o no va a hacerlo, como dijo a las dieciocho horas del día de ayer? ¿Usted va a hacer una reforma laboral, como dijo a las diecinueve horas de un lunes pactando con Convergència, o no va a hacerla, como dijo a las nueve horas del martes siguiente? ¿Usted va a controlar el déficit o, por el contrario, no va a controlarlo? ¿Usted va a cerrar la central de Garoña, como dice su programa, o no va a cerrarla, como dice el Consejo de Seguridad Nuclear y quiere el ministro de Industria? ¿Usted va a pactar su política económica con Izquierda Unida o con otros grupos? Porque evidentemente no es lo mismo, señor presidente. Aquí, con usted, nada es previsible, todo es imprevisible, y así es imposible generar confianza. Perdone que le diga que esto parece un circo y que no tiene ninguna gracia, porque estamos hablando de 4 millones de parados y en una situación como esta lo peor que le puede pasar a nuestro país es tener un gobierno sin un criterio claro en materia de política económica, un gobierno que da bandazos, que un día dice una cosa, otro día dice otra y solo genera desconfianza e incertidumbre. (Varios señores diputados: ¡Muy bien!-Prolongados aplausos.)"]}].map(party);

data.speakers = {"JOAN RIDAO I MARTÍN": {name: "JOAN RIDAO I MARTÍN", title: "Izquierda Unida"}, "JOAN RIDAO I MARTÍN": {name: "Joan Ridao i Martín", title: "Izquierda Unida"}, "JOSÉ LUIS RODRÍGUEZ ZAPATERO": {name: "José Luis Rodríguez Zapatero", title: "Socialista (PSOE)"}, "JOSU IÑAKI ERKOREKA GERVASIO": {name: "JOSU IÑAKI ERKOREKA GERVASIO", title: "PNV"}, "MARIANO RAJOY BREY": {name: "MARIANO RAJOY BREY", title: "Popular (PP)"}, "MARIANO RAJOY BREY": {name: "Mariano Rajoy Brey", title: "Popular (PP)"}};

data.topics = [{name: "empresas", re: /\b(empresas)\b/gi, x: 88.0, y: 88.0}, {name: "economía", re: /\b(economía)\b/gi, x: 152.0, y: 60.0}, {name: "mujeres", re: /\b(mujeres)\b/gi, x: 212.0, y: 56.0}, {name: "empresa", re: /\b(empresa)\b/gi, x: 270.0, y: 54.0}, {name: "familias", re: /\b(familias)\b/gi, x: 328.0, y: 54.0}, {name: "seguridad", re: /\b(seguridad)\b/gi, x: 376.0, y: 44.0}, {name: "línea", re: /\b(línea)\b/gi, x: 410.0, y: 30.0}, {name: "salud", re: /\b(salud)\b/gi, x: 442.0, y: 28.0}, {name: "madrid", re: /\b(madrid)\b/gi, x: 474.0, y: 28.0}, {name: "datos", re: /\b(datos)\b/gi, x: 506.0, y: 28.0}, {name: "desarrollo", re: /\b(desarrollo)\b/gi, x: 536.0, y: 26.0}, {name: "españoles", re: /\b(españoles)\b/gi, x: 564.0, y: 24.0}, {name: "presidencia", re: /\b(presidencia)\b/gi, x: 592.0, y: 24.0}, {name: "economía española", re: /\b(economía española)\b/gi, x: 618.0, y: 22.0}, {name: "autónomos", re: /\b(autónomos)\b/gi, x: 644.0, y: 22.0}].map(topic);

data.topic = function(name) {
  var t = topic({name: name, re: new RegExp("\\b(" + d3.requote(name) + ")\\b", "gi")}, data.topics.length);
  data.topics.push(t);
  return t;
};

function party(party) {
  party.speeches = party.speeches.map(speech);
  party.sections = sections(party.speeches);
  party.wordCount = d3.sum(party.sections, function(d) { return countWords(d.speech.text.substring(d.i, d.j)); });
  return party;
}

function speech(text, i) {
  return {text: text, id: i};
}

function sections(speeches) {
  // PFS: Afegeixo alguns caracters accentuats que no pertanyen a l'alfabet anglès
  // var speakerRe = /(?:\n|^)([A-Z\.()\- ]+): /g,
  var speakerRe = /(?:\n|^)([A-ZÁÉÍÓÚÑÀÈÇ\.()\- ]+): /g,
      sections = [];

  speeches.forEach(function(speech) {
    var speakerName = "AUDIENCE",
        match,
        i = speakerRe.lastIndex = 0;
    while (match = speakerRe.exec(speech.text)) {
      if (match.index > i) sections.push({speaker: speakerName, speech: speech, i: i, j: match.index});
      speakerName = match[1];
      i = speakerRe.lastIndex;
    }
    sections.push({speaker: speakerName, speech: speech, i: i, j: speech.text.length});
  });

  return sections.filter(function(d) { return !/^AUDIENCE\b/.test(d.speaker); });
}

function topic(topic, i) {
  topic.id = i;
  topic.count = 0;
  topic.cx = topic.x;
  topic.cy = topic.y;

  topic.parties = data.parties.map(function(party) {
    var count = 0,
        mentions = [];

    party.sections.forEach(function(section) {
      var text = section.speech.text.substring(section.i, section.j), match;
      topic.re.lastIndex = 0;
      while (match = topic.re.exec(text)) {
        ++count;
        mentions.push({
          topic: topic,
          section: section,
          i: section.i + match.index,
          j: section.i + topic.re.lastIndex
        });
      }
    });

    topic.count += count = count / party.wordCount * 25e3;
    return {count: count, mentions: mentions};
  });

  return topic;
}

function countWords(text) {
  return text.split(/\s+/g)
      .filter(function(d) { return d !== "—"; })
      .length;
}

})();

(function() {

var width = 970,
    height = 540;

var collisionPadding = 4,
    clipPadding = 4,
    minRadius = 16, // minimum collision radius
    maxRadius = 65, // also determines collision search radius
    maxMentions = 100, // don't show full transcripts
    activeTopic; // currently-displayed topic

var formatShortCount = d3.format(",.0f"),
    formatLongCount = d3.format(".1f"),
    formatCount = function(d) { return (d < 10 ? formatLongCount : formatShortCount)(d); };

var r = d3.scale.sqrt()
    .domain([0, d3.max(data.topics, function(d) { return d.count; })])
    .range([0, maxRadius]);

var force = d3.layout.force()
    .charge(0)
    .size([width, height - 80])
    .on("tick", tick);

var node = d3.select(".g-nodes").selectAll(".g-node"),
    label = d3.select(".g-labels").selectAll(".g-label"),
    arrow = d3.select(".g-nodes").selectAll(".g-note-arrow");

d3.select(".g-nodes").append("rect")
    .attr("class", "g-overlay")
    .attr("width", width)
    .attr("height", height)
    .on("click", clear);

d3.select(window)
    .on("hashchange", hashchange);

d3.select("#g-form")
    .on("submit", submit);

updateTopics(data.topics);
hashchange();

// Update the known topics.
function updateTopics(topics) {
  topics.forEach(function(d) {
    d.r = r(d.count);
    d.cr = Math.max(minRadius, d.r);
    d.k = fraction(d.parties[0].count, d.parties[1].count);
    if (isNaN(d.k)) d.k = .5;
    if (isNaN(d.x)) d.x = (1 - d.k) * width + Math.random();
    d.bias = .5 - Math.max(.1, Math.min(.9, d.k));
  });
  force.nodes(data.topics = topics).start();
  updateNodes();
  updateLabels();
  updateArrows();
  tick({alpha: 0}); // synchronous update
}

// Update the displayed nodes.
function updateNodes() {
  node = node.data(data.topics, function(d) { return d.name; });

  node.exit().remove();

  var nodeEnter = node.enter().append("a")
      .attr("class", "g-node")
      .attr("xlink:href", function(d) { return "#" + encodeURIComponent(d.name); })
      .call(force.drag)
      .call(linkTopic);

  var democratEnter = nodeEnter.append("g")
      .attr("class", "g-democrat");

  democratEnter.append("clipPath")
      .attr("id", function(d) { return "g-clip-democrat-" + d.id; })
    .append("rect");

  democratEnter.append("circle");

  var republicanEnter = nodeEnter.append("g")
      .attr("class", "g-republican");

  republicanEnter.append("clipPath")
      .attr("id", function(d) { return "g-clip-republican-" + d.id; })
    .append("rect");

  republicanEnter.append("circle");

  nodeEnter.append("line")
      .attr("class", "g-split");

  node.selectAll("rect")
      .attr("y", function(d) { return -d.r - clipPadding; })
      .attr("height", function(d) { return 2 * d.r + 2 * clipPadding; });

  node.select(".g-democrat rect")
      .style("display", function(d) { return d.k > 0 ? null : "none" })
      .attr("x", function(d) { return -d.r - clipPadding; })
      .attr("width", function(d) { return 2 * d.r * d.k + clipPadding; });

  node.select(".g-republican rect")
      .style("display", function(d) { return d.k < 1 ? null : "none" })
      .attr("x", function(d) { return -d.r + 2 * d.r * d.k; })
      .attr("width", function(d) { return 2 * d.r; });

  node.select(".g-democrat circle")
      .attr("clip-path", function(d) { return d.k < 1 ? "url(#g-clip-democrat-" + d.id + ")" : null; });

  node.select(".g-republican circle")
      .attr("clip-path", function(d) { return d.k > 0 ? "url(#g-clip-republican-" + d.id + ")" : null; });

  node.select(".g-split")
      .attr("x1", function(d) { return -d.r + 2 * d.r * d.k; })
      .attr("y1", function(d) { return -Math.sqrt(d.r * d.r - Math.pow(-d.r + 2 * d.r * d.k, 2)); })
      .attr("x2", function(d) { return -d.r + 2 * d.r * d.k; })
      .attr("y2", function(d) { return Math.sqrt(d.r * d.r - Math.pow(-d.r + 2 * d.r * d.k, 2)); });

  node.selectAll("circle")
      .attr("r", function(d) { return r(d.count); });
}

// Update the displayed node labels.
function updateLabels() {
  label = label.data(data.topics, function(d) { return d.name; });

  label.exit().remove();

  var labelEnter = label.enter().append("a")
      .attr("class", "g-label")
      .attr("href", function(d) { return "#" + encodeURIComponent(d.name); })
      .call(force.drag)
      .call(linkTopic);

  labelEnter.append("div")
      .attr("class", "g-name")
      .text(function(d) { return d.name; });

  labelEnter.append("div")
      .attr("class", "g-value");

  label
      .style("font-size", function(d) { return Math.max(8, d.r / 2) + "px"; })
      .style("width", function(d) { return d.r * 2.5 + "px"; });

  // Create a temporary span to compute the true text width.
  label.append("span")
      .text(function(d) { return d.name; })
      .each(function(d) { d.dx = Math.max(d.r * 2.5, this.getBoundingClientRect().width); })
      .remove();

  label
      .style("width", function(d) { return d.dx + "px"; })
    .select(".g-value")
      .text(function(d) { return formatShortCount(d.parties[0].count) + " - " + formatShortCount(d.parties[1].count); });

  // Compute the height of labels when wrapped.
  label.each(function(d) { d.dy = this.getBoundingClientRect().height; });
}

// Update the active topic.
function updateActiveTopic(topic) {
  d3.selectAll(".g-head").attr("class", topic ? "g-head g-has-topic" : "g-head g-hasnt-topic");
  if (activeTopic = topic) {
    node.classed("g-selected", function(d) { return d === topic; });
    updateMentions(findMentions(topic));
    d3.selectAll(".g-head a").text(topic.name);
    d3.select(".g-democrat .g-head span.g-count").text(formatCount(topic.parties[0].count));
    d3.select(".g-republican .g-head span.g-count").text(formatCount(topic.parties[1].count));
  } else {
    node.classed("g-selected", false);
    updateMentions(sampleMentions());
    d3.selectAll(".g-head a").text("various topics");
    d3.selectAll(".g-head span.g-count").text("some number of");
  }
}

// Update displayed excerpts.
function updateMentions(mentions) {
  var column = d3.selectAll(".g-mentions")
      .data(mentions);

  column.select(".g-truncated")
      .style("display", function(d) { return d.truncated ? "block" : null; });

  var mention = column.selectAll(".g-mention")
      .data(groupMentionsBySpeaker, function(d) { return d.key; });

  mention.exit().remove();

  mention.selectAll("p")
      .remove();

  var mentionEnter = mention.enter().insert("div", ".g-truncated")
      .attr("class", "g-mention");

  mentionEnter.append("div")
      .attr("class", "g-speaker")
      .text(function(d) { var s = data.speakers[d.key]; return s ? s.name : d.key; });

  mentionEnter.append("div")
      .attr("class", "g-speaker-title")
      .text(function(d) { var s = data.speakers[d.key]; return s && s.title; });

  mention
      .sort(function(a, b) { return b.values.length - a.values.length; });

  var p = mention.selectAll("p")
      .data(function(d) { return d.values; })
    .enter().append("p")
      .html(function(d) { return d.section.speech.text.substring(d.start, d.end).replace(d.topic.re, "<a>$1</a>"); });

  if (activeTopic) {
    p.attr("class", "g-hover");
  } else {
    p.each(function(d) {
      d3.select(this).selectAll("a")
          .datum(d.topic)
          .attr("href", "#" + encodeURIComponent(d.topic.name))
          .call(linkTopic);
    });
  }
}

// Bind the arrow path elements with their associated topic.
function updateArrows() {
  arrow = arrow.data(
      data.topics.filter(function(d) { return d.arrow; }),
      function(d) { return this.id ? this.id.substring(8) : d.arrow; });
}

// Return a random sample of mentions per party, one per topic.
// Mentions are returned in chronological order.
function sampleMentions() {
  return data.parties.map(function(party, i) {
    return data.topics
        .map(function(d) { return d.parties[i].mentions; })
        .filter(function(d) { return d.length; })
        .map(function(d) { return d[Math.floor(Math.random() * d.length)]; })
        .sort(orderMentions);
  });
}

// Return displayable mentions per party for the specified topic.
// If too many, a random sample of matching mentions is returned.
// Mentions are returned in chronological order.
function findMentions(topic) {
  return data.parties.map(function(party, i) {
    var mentions = topic.parties[i].mentions;
    if (mentions.length > maxMentions) {
      shuffle(mentions).length = maxMentions;
      mentions.sort(orderMentions);
      mentions.truncated = true;
    }
    return mentions;
  });
}

// Group mentions by speaker, collapse overlapping excerpts.
function groupMentionsBySpeaker(mentions) {
  return d3.nest()
      .key(function(d) { return d.section.speaker; })
      .rollup(collapseMentions)
      .entries(mentions);
}

// Given an array of mentions, computes the start and end point of the context
// excerpt, and then collapses any overlapping excerpts.
function collapseMentions(mentions) {
  var sentenceRe = /([!?.)]+)\s+/g, // sentence splitting requires NLP
      i,
      n = mentions.length,
      d0,
      d1;

  // First compute the excerpt contexts.
  for (i = 0; i < n; ++i) {
    d0 = mentions[i];
    d0.start = excerptStart(d0);
    d0.end = excerptEnd(d0);
  }

  // Then collapse any overlapping excerpts (from the same speech).
  for (i = 1, d1 = mentions[0]; i < n; ++i) {
    d0 = d1;
    d1 = mentions[i];
    if (d1.section.speech.id === d0.section.speech.id
        && d1.start >= d0.start
        && d1.start < d0.end) {
      d1.start = -1;
      d0.end = d1.end;
      d1 = d0;
    }
  }

  // Returns the start index of the excerpt for the specified mention.
  function excerptStart(mention) {
    var i = sentenceRe.lastIndex = Math.max(mention.section.i, mention.i - 80), match;
    while (match = sentenceRe.exec(mention.section.speech.text)) {
      if (match.index < mention.i - 20) return match.index + match[0].length;
      if (i <= mention.section.i) break;
      sentenceRe.lastIndex = i = Math.max(mention.section.i, i - 20);
    }
    return mention.section.i;
  }

  // Returns the end index of the excerpt for the specified mention.
  function excerptEnd(mention) {
    var i = mention.section.j, match;
    sentenceRe.lastIndex = mention.j + 40;
    match = sentenceRe.exec(mention.section.speech.text);
    return match ? Math.min(match.index + match[1].length, i) : i;
  }

  return mentions.filter(function(d) { return d.start >= 0; });
}

// Orders mentions chronologically: by speech and position within speech.
function orderMentions(a, b) {
  return a.section.speech.id - b.section.speech.id || a.i - b.i;
}

// Assign event handlers to topic links.
function linkTopic(a) {
  a   .on("click", click)
      .on("mouseover", mouseover)
      .on("mouseout", mouseout);
}

// Returns the topic matching the specified name, approximately.
// If no matching topic is found, returns undefined.
function findTopic(name) {
  for (var i = 0, n = data.topics.length, t; i < n; ++i) {
    if ((t = data.topics[i]).name === name || new RegExp("^" + (t = data.topics[i]).re.source + "$", "i").test(name)) {
      return t;
    }
  }
}

// Returns the topic matching the specified name, approximately.
// If no matching topic is found, a new one is created.
function findOrAddTopic(name) {
  var topic = findTopic(name);
  if (!topic) {
    topic = data.topic(name.substring(0, 1).toUpperCase() + name.substring(1));
    topic.y = 0;
    updateTopics(data.topics);
  }
  return topic;
}

// Simulate forces and update node and label positions on tick.
function tick(e) {
  node
      .each(bias(e.alpha * 105))
      .each(collide(.5))
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  label
      .style("left", function(d) { return (d.x - d.dx / 2) + "px"; })
      .style("top", function(d) { return (d.y - d.dy / 2) + "px"; });

  arrow.style("stroke-opacity", function(d) {
    var dx = d.x - d.cx, dy = d.y - d.cy;
    return dx * dx + dy * dy < d.r * d.r ? 1: 0;
  });
}

// A left-right bias causing topics to orient by party preference.
function bias(alpha) {
  return function(d) {
    d.x += d.bias * alpha;
  };
}

function rotate() {
	return function(d) {
	var c = Math.cos(Math.PI/8.);
	var s = Math.sin(Math.PI/8.);
	
	d.x -= width/2.;
	d.y -= height/2.
	
	var n_x = d.x*c - d.y*s;
	var n_y = d.x*s + d.y*c;
	
	d.x = n_x + width/2.;
	d.y = n_y + height/2.;
	};
}

// Resolve collisions between nodes.
function collide(alpha) {
  var q = d3.geom.quadtree(data.topics);
  return function(d) {
    var r = d.cr + maxRadius + collisionPadding,
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    q.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d) && d.other !== quad.point && d !== quad.point.other) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.cr + quad.point.r + collisionPadding;
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
  };
}

// Fisher–Yates shuffle.
function shuffle(array) {
  var m = array.length, t, i;
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = array[m];
    array[m] = array[i];
    array[i] = t;
  }
  return array;
}

// Given two quantities a and b, returns the fraction to split the circle a + b.
function fraction(a, b) {
  var k = a / (a + b);
  if (k > 0 && k < 1) {
    var t0, t1 = Math.pow(12 * k * Math.PI, 1 / 3);
    for (var i = 0; i < 10; ++i) { // Solve for theta numerically.
      t0 = t1;
      t1 = (Math.sin(t0) - t0 * Math.cos(t0) + 2 * k * Math.PI) / (1 - Math.cos(t0));
    }
    k = (1 - Math.cos(t1 / 2)) / 2;
  }
  return k;
}

// Update the active topic on hashchange, perhaps creating a new topic.
function hashchange() {
  var name = decodeURIComponent(location.hash.substring(1)).trim();
  updateActiveTopic(name && name != "!" ? findOrAddTopic(name) : null);
}

// Trigger a hashchange on submit.
function submit() {
  var name = this.search.value.trim();
  location.hash = name ? encodeURIComponent(name) : "!";
  this.search.value = "";
  d3.event.preventDefault();
}

// Clear the active topic when clicking on the chart background.
function clear() {
  location.replace("#!");
}

// Rather than flood the browser history, use location.replace.
function click(d) {
  location.replace("#" + encodeURIComponent(d === activeTopic ? "!" : d.name));
  // PFS: 12/05/2015
  parent.resizeIframeByHeight(parent.document.getElementsByName('iframe_a')[0],document.getElementById('interactiveABC').scrollHeight);
  d3.event.preventDefault();
}

// When hovering the label, highlight the associated node and vice versa.
// When no topic is active, also cross-highlight with any mentions in excerpts.
function mouseover(d) {
  node.classed("g-hover", function(p) { return p === d; });
  if (!activeTopic) d3.selectAll(".g-mention p").classed("g-hover", function(p) { return p.topic === d; });
}

// When hovering the label, highlight the associated node and vice versa.
// When no topic is active, also cross-highlight with any mentions in excerpts.
function mouseout(d) {
  node.classed("g-hover", false);
  if (!activeTopic) d3.selectAll(".g-mention p").classed("g-hover", false);
}

})();
